#!/usr/bin/env python3
"""
This script is a shortcut to initiating the integration analysis phase of the
spatial analysis pipeline begun with sat-pipeline, even before that pipeline has
fully completed. The purpose is to make some results available early based on
partially-complete computations.
"""
import os
import configparser

from spatial_analysis_toolbox.api import get_design, get_integrator
from spatial_analysis_toolbox.environment.configuration import config_filename
from spatial_analysis_toolbox.environment.log_formats import colorized_logger

logger = colorized_logger(__name__)

def get_config_file_parameters(f):
    config = configparser.ConfigParser()
    config.read(f)
    parameters = dict(config['default'])
    return parameters

if not os.path.exists(config_filename):
    logger.error('Could not locate configuration file. Running in wrong directory?')
    exit()
p = get_config_file_parameters(config_filename)
w = p['workflow']

if w == 'Multiplexed IF diffusion':
    design = get_design(
        elementary_phenotypes_file=p['elementary_phenotypes_file'],
        complex_phenotypes_file=p['complex_phenotypes_file'],
        workflow=w,
    )

if w == 'Multiplexed IF phenotype proximity':
    design = get_design(
        elementary_phenotypes_file=p['elementary_phenotypes_file'],
        complex_phenotypes_file=p['complex_phenotypes_file'],
        workflow=w,
    )

i = get_integrator(
    workflow=w,
    output_path=p['output_path'],
    outcomes_file=p['outcomes_file'],
    design=design,
)
i.calculate()
