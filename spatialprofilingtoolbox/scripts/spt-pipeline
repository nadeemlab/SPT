#!/usr/bin/env python3
import argparse

import spatialprofilingtoolbox as spt


if __name__=='__main__':
    parser = argparse.ArgumentParser(
        description = 'The entry point into SPT (Spatial Profiling Toolbox) commands.'
    )
    generate_jobs = 'generate-jobs'
    configure = 'configure'
    single_job = 'single-job'
    aggregate_results = 'aggregate-results'
    parser.add_argument(
        'command_token',
        nargs='?',
        choices = [generate_jobs, configure, single_job, aggregate_results],
    )
    parser.add_argument('--input-file-identifier',
        dest='input_file_identifier',
        type=str,
        required=False,
        help='An input file identifier, as it appears in the file manifest.',
    )
    parser.add_argument('--fov',
        dest='fov_index',
        type=int,
        required=False,
        help='Indication of field of view to consider (one-based integer index). Only pertains to some workflows.',
    )
    args = parser.parse_args()
    parameters = {}
    parameters['input_file_identifier'] = args.input_file_identifier
    parameters['fov_index'] = args.fov_index

    command = args.command_token
    if command == configure:
        spt.configuration_dialog()
        exit()

    parameters = {**parameters, **spt.get_config_parameters()}

    if command == generate_jobs:
        job_generator = spt.get_job_generator(**parameters)
        job_generator.generate()

    if command == single_job:
        analyzer = spt.get_analyzer(**parameters)
        analyzer.calculate()

    if command == aggregate_results:
        integrator = spt.get_integrator(**parameters)
        integrator.calculate()
